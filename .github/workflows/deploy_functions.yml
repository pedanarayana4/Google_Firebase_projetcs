  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'

  - name: Write GCP key file
    if: ${{ secrets.GCP_SA_KEY != '' }}
    run: |
      echo "${{ secrets.GCP_SA_KEY }}" > "$HOME/gcloud-key.json"
      chmod 600 "$HOME/gcloud-key.json"
      echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV

  - name: Install firebase-tools
    run: |
      npm ci --silent || true
      npm install -g firebase-tools@latest

  - name: Verify auth & versions
    run: |
      echo "GCP key file present? $( [ -f \"$HOME/gcloud-key.json\" ] && echo yes || echo no )"
      node -v && npm -v && firebase --version

  - name: Deploy to Firebase
    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    run: |
      if [ -n "${FIREBASE_TOKEN}" ]; then
        firebase deploy --only hosting --token "${FIREBASE_TOKEN}" --project fir-learning-a511d
      else
        firebase deploy --only hosting --project fir-learning-a511d
      fi